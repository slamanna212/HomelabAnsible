---
# Set OS-specific variables for repository configuration
- name: Set OS distribution for nginx repository
  set_fact:
    nginx_os_distribution: "{{ 'ubuntu' if ansible_facts['distribution'] == 'Ubuntu' else 'debian' }}"
    nginx_os_codename: "{{ ansible_facts['distribution_release'] }}"

# Modern GPG key management
- name: Create keyring directory
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'

- name: Download nginx GPG key
  get_url:
    url: https://nginx.org/keys/nginx_signing.key
    dest: /tmp/nginx_signing.key
    mode: '0644'

- name: Add nginx GPG key to keyring
  shell: |
    gpg --dearmor < /tmp/nginx_signing.key > /etc/apt/keyrings/nginx-archive-keyring.gpg
  args:
    creates: /etc/apt/keyrings/nginx-archive-keyring.gpg

- name: Remove temporary key file
  file:
    path: /tmp/nginx_signing.key
    state: absent

# Add repositories with signed-by
- name: Add nginx repository
  apt_repository:
    repo: "deb [signed-by=/etc/apt/keyrings/nginx-archive-keyring.gpg] https://nginx.org/packages/{{ nginx_os_distribution }}/ {{ nginx_os_codename }} nginx"
    filename: nginx
    state: present

- name: Add nginx source repository
  apt_repository:
    repo: "deb-src [signed-by=/etc/apt/keyrings/nginx-archive-keyring.gpg] https://nginx.org/packages/{{ nginx_os_distribution }}/ {{ nginx_os_codename }} nginx"
    filename: nginx
    state: present

# Set default PHP version before package install
- name: Set default PHP version
  set_fact:
    php_version: "8.3"
  when: php_version is not defined

- name: Install required system packages
  apt:
    name={{ sys_packages }}
    state=present
    update_cache=yes

# Detect actual installed PHP version
- name: Detect installed PHP version
  shell: "php -r 'echo PHP_MAJOR_VERSION . \".\" . PHP_MINOR_VERSION;'"
  register: php_version_output
  changed_when: false

- name: Set PHP version variable from detected installation
  set_fact:
    php_version: "{{ php_version_output.stdout }}"

- name: Adds ansible user to www-data group
  user:
    name: ansible
    state: present
    groups: www-data
    append: true

# Configure Nginx
- name: Remove default Nginx site config
  ansible.builtin.file:
    path: /etc/nginx/conf.d/default.conf
    state: absent
  notify: restart nginx    

- name: Update Nginx config
  template: 
    src=nginx.conf 
    dest=/etc/nginx/nginx.conf 
    backup=no
  notify: restart nginx        

# Configure PHP
- name: Copy PHP config
  become: yes
  become_user: root
  copy:
    src: php.ini
    dest: "/etc/php/{{ php_version }}/fpm/php.ini"
    backup: no
  notify: restart php-fpm

- name: Update php-fpm pool config
  become: yes
  become_user: root
  template:
    src: www.conf.j2
    dest: "/etc/php/{{ php_version }}/fpm/pool.d/www.conf"
    backup: no
  notify: restart php-fpm        

# Configure FastCGI Cache
- name: Find all current live websites
  find:
    paths: /mnt/Web/Websites/Wordpress/
    file_type: directory
  register: find_result

- name: Create cache directories if missing
  become: yes
  become_user: root            
  file:
    path: "/opt/Cache/{{ item }}"
    state: directory
  loop: "{{ find_result['files'] | map(attribute='path') | map('regex_replace','^.*/(.*)$','\\1') | list }}"

- name: Set permissions on cache directorys
  become: yes
  become_user: root            
  ansible.builtin.file:
    path: /opt/Cache/
    state: directory
    owner: www-data
    group: www-data
    recurse: yes

# WP-CLI
- name: Check if WP_CLI exists
  stat: path="/usr/local/bin/wp"
  register: wpcli_exist

- name: Updating WP-CLI
  shell: "/usr/local/bin/wp cli update --yes"
  when: wpcli_exist.stat.exists

- name: Download WP-CLI
  get_url:
    url="https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar"
    dest="/usr/local/bin/wp"
    force_basic_auth=yes
    mode=0755
  when: not wpcli_exist.stat.exists