---
plugin: community.proxmox.proxmox

# Explicitly set parameters from environment variables
url: "{{ lookup('env', 'PROXMOX_URL') }}"
user: "{{ lookup('env', 'PROXMOX_USER') }}"
token_id: "{{ lookup('env', 'PROXMOX_TOKEN_ID') }}"
token_secret: "{{ lookup('env', 'PROXMOX_TOKEN_SECRET') }}"

# SSL certificate validation
validate_certs: false

# Gather VM facts
want_facts: true

# Set ansible_host to VM IP address
# For QEMU VMs: extract from guest agent interfaces (proxmox_agent_interfaces)
# For LXC containers: extract from proxmox_net0.ip
compose:
  # First try agent interfaces (get first non-lo interface by name), then fall back to net0.ip for LXC
  ansible_host: ((proxmox_agent_interfaces | default([]) | selectattr('name', 'in', ['eth0', 'ens18', 'ens19', 'ens20']) | list | first | default({}))['ip-addresses'] | default([]) | select('match', '^[0-9]{1,3}\\.') | reject('match', '^127\\.') | reject('match', '^172\\.(1[6-9]|2[0-9]|3[0-1])\\.') | list | first | default(proxmox_net0.ip | default(''))) | regex_replace('/.*$', '')

# Create groups based on VM tags
keyed_groups:
  - key: proxmox_tags_parsed
    separator: ""
